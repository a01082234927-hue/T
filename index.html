<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>이음 번역 - 통합 자바스크립트 버전</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <style>
        body { margin: 0; background: #222; color: white; font-family: sans-serif; overflow: hidden; }
        #ui { position: absolute; top: 20px; width: 100%; text-align: center; z-index: 10; }
        input { padding: 12px; border-radius: 8px; border: none; width: 200px; }
        button { padding: 12px 20px; background: #4a90e2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #status { position: absolute; bottom: 20px; width: 100%; text-align: center; color: #00ff00; font-weight: bold; }
        video { display: none; } /* 원본 영상은 숨김 */
    </style>
</head>
<body>

<div id="ui">
    <h1>이음 수어 번역 (JS 통합형)</h1>
    <input type="text" id="wordInput" placeholder="단어 입력 (예: 안녕)">
    <button onclick="startProcess()">번역 시작</button>
</div>
<div id="status">시스템 준비 중...</div>
<video id="input_video" crossorigin="anonymous"></video>

<script>
    let scene, camera, renderer, model;
    const videoElement = document.getElementById('input_video');
    const API_KEY = "Pl0efgTL-HoYg-1U5v-EMhu-Fi8gGOGT";

    // 1. 3D 아바타 초기 설정
    initThreeJS();

    function initThreeJS() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.4, 1.8);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 1));
        
        const loader = new THREE.GLTFLoader();
        loader.load('https://models.readyplayer.me/694369bf5868c9e39dd46145.glb', (gltf) => {
            model = gltf.scene;
            scene.add(model);
            updateStatus("준비 완료! 단어를 입력하세요.");
        });

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();
    }

    // 2. MediaPipe 설정 (자바스크립트 버전)
    const holistic = new Holistic({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`;
    }});

    holistic.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    // 동작이 분석될 때마다 실행되는 함수
    holistic.onResults((results) => {
        if (!results.poseLandmarks || !model) return;

        const pose = results.poseLandmarks;
        const rArm = model.getObjectByName('RightArm');
        const rForeArm = model.getObjectByName('RightForeArm');

        // 수학 공식: 어깨와 팔꿈치 사이 각도 계산
        if(rArm && pose[12] && pose[14]) {
            let angle = Math.atan2(pose[14].y - pose[12].y, pose[14].x - pose[12].x);
            rArm.rotation.z = angle + Math.PI/2;
        }
    });

    // 3. 메인 로직: 단어 검색 -> 영상 로드 -> 동작 분석 -> 아바타 적용
    async function startProcess() {
        const word = document.getElementById('wordInput').value;
        if (!word) return;

        updateStatus(`'${word}' 영상을 찾는 중...`);
        
        // 국립국어원 API 호출 (CORS 우회를 위해 프록시 사용이 필요할 수 있음)
        const searchUrl = `https://sldict.korean.go.kr/api/search?key=${API_KEY}&q=${word}&method=word`;
        
        try {
            // 실제 배포 시에는 CORS 정책 때문에 서버 경유가 필요하지만, 
            // 로컬 테스트 시 크롬 보안 설정을 끄면 바로 작동합니다.
            const response = await fetch(searchUrl);
            const text = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "text/xml");
            const movieUrl = xmlDoc.getElementsByTagName("movie_path")[0].childNodes[0].nodeValue;

            updateStatus("동작 분석 중... 아바타를 확인하세요.");
            videoElement.src = movieUrl;
            videoElement.play();

            // 영상 프레임을 실시간으로 분석
            async function processVideo() {
                if (!videoElement.paused && !videoElement.ended) {
                    await holistic.send({image: videoElement});
                    requestAnimationFrame(processVideo);
                } else {
                    updateStatus("재생 완료!");
                }
            }
            videoElement.onplay = processVideo;

        } catch (e) {
            updateStatus("오류: 영상을 불러올 수 없습니다. (CORS 문제일 수 있음)");
            console.error(e);
        }
    }

    function updateStatus(msg) {
        document.getElementById('status').innerText = msg;
    }
</script>
</body>
</html>
